# æ­¥éª¤5ï¼šç”Ÿäº§éƒ¨ç½²è¯¦ç»†æ“ä½œæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£å°†è¯¦ç»†æŒ‡å¯¼æ‚¨å¦‚ä½•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²å·²æ„å»ºå¥½çš„ Rocket.Chat Docker é•œåƒã€‚æˆ‘ä»¬å°†ä½¿ç”¨ Docker Compose è¿›è¡Œéƒ¨ç½²ï¼ŒåŒ…å«å®Œæ•´çš„æ•°æ®åº“ã€åå‘ä»£ç†ã€SSL è¯ä¹¦ç­‰é…ç½®ã€‚

## ğŸ¯ éƒ¨ç½²ç›®æ ‡

- éƒ¨ç½²å®šåˆ¶åŒ–çš„ Rocket.Chat åº”ç”¨ï¼ˆåŒ…å« HT.Chat å“ç‰Œï¼‰
- é…ç½® MongoDB æ•°æ®åº“
- è®¾ç½® Nginx åå‘ä»£ç†
- é…ç½® SSL è¯ä¹¦ï¼ˆLet's Encryptï¼‰
- å®ç°è‡ªåŠ¨å¤‡ä»½å’Œç›‘æ§

## ğŸ“‹ å‰ç½®è¦æ±‚

### æœåŠ¡å™¨è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **CPU**: æœ€ä½ 2 æ ¸ï¼Œæ¨è 4 æ ¸
- **å†…å­˜**: æœ€ä½ 4GBï¼Œæ¨è 8GB
- **å­˜å‚¨**: æœ€ä½ 50GBï¼Œæ¨è 100GB SSD
- **ç½‘ç»œ**: å…¬ç½‘ IP åœ°å€

### åŸŸåè¦æ±‚
- å·²æ³¨å†Œçš„åŸŸåï¼ˆå¦‚ï¼šchat.yourcompany.comï¼‰
- DNS è®°å½•å·²æŒ‡å‘æœåŠ¡å™¨ IP

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 è¿æ¥åˆ°æœåŠ¡å™¨

```bash
# ä½¿ç”¨ SSH è¿æ¥åˆ°æ‚¨çš„æœåŠ¡å™¨
ssh root@your-server-ip

# æˆ–ä½¿ç”¨æ™®é€šç”¨æˆ·ï¼ˆæ¨èï¼‰
ssh username@your-server-ip
```

### 1.2 æ›´æ–°ç³»ç»Ÿ

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
# æˆ–è€…å¯¹äºè¾ƒæ–°ç‰ˆæœ¬
sudo dnf update -y
```

### 1.3 å®‰è£…å¿…è¦å·¥å…·

```bash
# Ubuntu/Debian
sudo apt install -y curl wget git unzip htop nano

# CentOS/RHEL
sudo yum install -y curl wget git unzip htop nano
```

## ğŸ³ ç¬¬äºŒæ­¥ï¼šå®‰è£… Docker å’Œ Docker Compose

### 2.1 å®‰è£… Docker

#### Ubuntu/Debian ç³»ç»Ÿï¼š

```bash
# å¸è½½æ—§ç‰ˆæœ¬
sudo apt remove docker docker-engine docker.io containerd runc

# å®‰è£…ä¾èµ–
sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release

# æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# æ·»åŠ  Docker ä»“åº“
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# æ›´æ–°åŒ…ç´¢å¼•å¹¶å®‰è£… Docker
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io
```

#### CentOS/RHEL ç³»ç»Ÿï¼š

```bash
# å¸è½½æ—§ç‰ˆæœ¬
sudo yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-engine

# å®‰è£…ä¾èµ–
sudo yum install -y yum-utils

# æ·»åŠ  Docker ä»“åº“
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo

# å®‰è£… Docker
sudo yum install -y docker-ce docker-ce-cli containerd.io
```

### 2.2 å¯åŠ¨å¹¶å¯ç”¨ Docker

```bash
# å¯åŠ¨ Docker æœåŠ¡
sudo systemctl start docker

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable docker

# éªŒè¯å®‰è£…
sudo docker --version
sudo docker run hello-world
```

### 2.3 å®‰è£… Docker Compose

```bash
# ä¸‹è½½ Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker-compose --version
```

### 2.4 é…ç½®ç”¨æˆ·æƒé™ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```bash
# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç»„
sudo usermod -aG docker $USER

# é‡æ–°ç™»å½•æˆ–æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä½¿æƒé™ç”Ÿæ•ˆ
newgrp docker

# éªŒè¯æ— éœ€ sudo å³å¯è¿è¡Œ docker
docker ps
```

## ğŸ“ ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºéƒ¨ç½²ç›®å½•ç»“æ„

### 3.1 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
# åˆ›å»ºéƒ¨ç½²æ ¹ç›®å½•
sudo mkdir -p /opt/rocketchat
cd /opt/rocketchat

# è®¾ç½®ç›®å½•æƒé™
sudo chown -R $USER:$USER /opt/rocketchat

# åˆ›å»ºå­ç›®å½•
mkdir -p {
  data/mongodb,
  data/uploads,
  logs,
  backups,
  ssl,
  config
}
```

### 3.2 ç›®å½•ç»“æ„è¯´æ˜

```
/opt/rocketchat/
â”œâ”€â”€ docker-compose.yml          # Docker Compose é…ç½®æ–‡ä»¶
â”œâ”€â”€ .env                        # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ mongodb/               # MongoDB æ•°æ®ç›®å½•
â”‚   â””â”€â”€ uploads/               # æ–‡ä»¶ä¸Šä¼ ç›®å½•
â”œâ”€â”€ logs/                      # æ—¥å¿—ç›®å½•
â”œâ”€â”€ backups/                   # å¤‡ä»½ç›®å½•
â”œâ”€â”€ ssl/                       # SSL è¯ä¹¦ç›®å½•
â””â”€â”€ config/
    â””â”€â”€ nginx.conf             # Nginx é…ç½®æ–‡ä»¶
```

## âš™ï¸ ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

### 4.1 åˆ›å»º .env æ–‡ä»¶

```bash
cd /opt/rocketchat
nano .env
```

### 4.2 .env æ–‡ä»¶å†…å®¹

```bash
# ===========================================
# Rocket.Chat ç”Ÿäº§ç¯å¢ƒé…ç½®
# ===========================================

# åŸºç¡€é…ç½®
ROOT_URL=https://chat.yourcompany.com
PORT=3000
MONGO_URL=mongodb://mongo:27017/rocketchat?replicaSet=rs0
MONGO_OPLOG_URL=mongodb://mongo:27017/local?replicaSet=rs0

# ç®¡ç†å‘˜é…ç½®
ADMIN_USERNAME=admin
ADMIN_PASS=your-secure-admin-password
ADMIN_EMAIL=admin@yourcompany.com

# MongoDB é…ç½®
MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=your-secure-mongo-password
MONGO_INITDB_DATABASE=rocketchat

# é‚®ä»¶é…ç½®ï¼ˆSMTPï¼‰
MAIL_URL=smtps://username:password@smtp.gmail.com:465
MAIL_FROM=noreply@yourcompany.com

# æ–‡ä»¶ä¸Šä¼ é…ç½®
FILE_UPLOAD_STORAGE_TYPE=GridFS
FILE_UPLOAD_MAX_FILE_SIZE=104857600

# å®‰å…¨é…ç½®
JWT_SECRET=your-jwt-secret-key-here
SESSION_SECRET=your-session-secret-key-here

# æ€§èƒ½é…ç½®
NODE_ENV=production
CACHE_DIR=/app/programs/server/assets/app

# SSL é…ç½®
SSL_CERT_PATH=/etc/letsencrypt/live/chat.yourcompany.com/fullchain.pem
SSL_KEY_PATH=/etc/letsencrypt/live/chat.yourcompany.com/privkey.pem

# åŸŸåé…ç½®ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸåï¼‰
DOMAIN=chat.yourcompany.com
EMAIL=admin@yourcompany.com

# Docker é•œåƒé…ç½®
ROCKETCHAT_IMAGE=ghcr.io/sl1018990955/rocketchat-custom:v6.7.3-htchat-r1
```

**âš ï¸ é‡è¦æé†’ï¼š**
- è¯·å°† `chat.yourcompany.com` æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸå
- è¯·å°†æ‰€æœ‰å¯†ç æ›¿æ¢ä¸ºå¼ºå¯†ç 
- è¯·å°†é‚®ç®±åœ°å€æ›¿æ¢ä¸ºæ‚¨çš„å®é™…é‚®ç®±

## ğŸ³ ç¬¬äº”æ­¥ï¼šåˆ›å»º Docker Compose é…ç½®

### 5.1 åˆ›å»º docker-compose.yml

```bash
cd /opt/rocketchat
nano docker-compose.yml
```

### 5.2 docker-compose.yml å†…å®¹

```yaml
version: '3.8'

services:
  # MongoDB æ•°æ®åº“
  mongo:
    image: mongo:6.0
    container_name: rocketchat-mongo
    restart: unless-stopped
    volumes:
      - ./data/mongodb:/data/db
      - ./backups:/backups
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE}
    command: >
      mongod 
      --oplogSize 128 
      --replSet rs0 
      --storageEngine wiredTiger
    networks:
      - rocketchat-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # MongoDB å‰¯æœ¬é›†åˆå§‹åŒ–
  mongo-init-replica:
    image: mongo:6.0
    container_name: rocketchat-mongo-init
    command: >
      bash -c
        "for i in `seq 1 30`; do
          mongo mongo/rocketchat --eval \"
            rs.initiate({
              _id: 'rs0',
              members: [ { _id: 0, host: 'localhost:27017' } ]})\"
          && s=$$? && break || s=$$?;
          echo \"Tried $$i times. Waiting 5 secs...\";
          sleep 5;
        done; (exit $$s)"
    depends_on:
      - mongo
    networks:
      - rocketchat-network

  # Rocket.Chat åº”ç”¨
  rocketchat:
    image: ${ROCKETCHAT_IMAGE}
    container_name: rocketchat-app
    restart: unless-stopped
    volumes:
      - ./data/uploads:/app/uploads
      - ./logs:/app/logs
    environment:
      ROOT_URL: ${ROOT_URL}
      PORT: ${PORT}
      MONGO_URL: ${MONGO_URL}
      MONGO_OPLOG_URL: ${MONGO_OPLOG_URL}
      MAIL_URL: ${MAIL_URL}
      MAIL_FROM: ${MAIL_FROM}
      FILE_UPLOAD_STORAGE_TYPE: ${FILE_UPLOAD_STORAGE_TYPE}
      FILE_UPLOAD_MAX_FILE_SIZE: ${FILE_UPLOAD_MAX_FILE_SIZE}
      NODE_ENV: ${NODE_ENV}
      CACHE_DIR: ${CACHE_DIR}
    depends_on:
      - mongo
    ports:
      - "3000:3000"
    networks:
      - rocketchat-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: rocketchat-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/letsencrypt:ro
      - /var/log/nginx:/var/log/nginx
    depends_on:
      - rocketchat
    networks:
      - rocketchat-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Certbot for SSL certificates
  certbot:
    image: certbot/certbot
    container_name: rocketchat-certbot
    volumes:
      - ./ssl:/etc/letsencrypt
      - ./config/certbot-webroot:/var/www/certbot
    command: certonly --webroot --webroot-path=/var/www/certbot --email ${EMAIL} --agree-tos --no-eff-email -d ${DOMAIN}
    networks:
      - rocketchat-network

networks:
  rocketchat-network:
    driver: bridge

volumes:
  mongodb-data:
  uploads-data:
```

## ğŸŒ ç¬¬å…­æ­¥ï¼šé…ç½® Nginx åå‘ä»£ç†

### 6.1 åˆ›å»º Nginx é…ç½®æ–‡ä»¶

```bash
cd /opt/rocketchat
nano config/nginx.conf
```

### 6.2 nginx.conf å†…å®¹

```nginx
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;
    
    # åŸºç¡€é…ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 100M;
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # ä¸Šæ¸¸æœåŠ¡å™¨é…ç½®
    upstream rocketchat {
        server rocketchat:3000;
    }
    
    # HTTP é‡å®šå‘åˆ° HTTPS
    server {
        listen 80;
        server_name chat.yourcompany.com;
        
        # Let's Encrypt éªŒè¯è·¯å¾„
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
        
        # å…¶ä»–è¯·æ±‚é‡å®šå‘åˆ° HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }
    
    # HTTPS æœåŠ¡å™¨é…ç½®
    server {
        listen 443 ssl http2;
        server_name chat.yourcompany.com;
        
        # SSL è¯ä¹¦é…ç½®
        ssl_certificate /etc/letsencrypt/live/chat.yourcompany.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/chat.yourcompany.com/privkey.pem;
        
        # SSL å®‰å…¨é…ç½®
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # å®‰å…¨å¤´
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        
        # ä»£ç†é…ç½®
        location / {
            proxy_pass http://rocketchat;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Nginx-Proxy true;
            
            proxy_redirect off;
            proxy_buffering off;
            proxy_cache_bypass $http_upgrade;
            
            # è¶…æ—¶é…ç½®
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }
}
```

**âš ï¸ é‡è¦ï¼š** è¯·å°†é…ç½®æ–‡ä»¶ä¸­çš„ `chat.yourcompany.com` æ›¿æ¢ä¸ºæ‚¨çš„å®é™…åŸŸåã€‚

## ğŸ”’ ç¬¬ä¸ƒæ­¥ï¼šè·å– SSL è¯ä¹¦

### 7.1 åˆ›å»º Certbot ç½‘ç«™æ ¹ç›®å½•

```bash
cd /opt/rocketchat
mkdir -p config/certbot-webroot
```

### 7.2 ä¸´æ—¶å¯åŠ¨ Nginxï¼ˆç”¨äºè¯ä¹¦éªŒè¯ï¼‰

```bash
# åˆ›å»ºä¸´æ—¶ Nginx é…ç½®ï¼ˆä»…ç”¨äºè·å–è¯ä¹¦ï¼‰
cat > config/nginx-temp.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name chat.yourcompany.com;
        
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }
        
        location / {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}
EOF

# å¯åŠ¨ä¸´æ—¶ Nginx
docker run -d --name temp-nginx \
  -p 80:80 \
  -v $(pwd)/config/nginx-temp.conf:/etc/nginx/nginx.conf:ro \
  -v $(pwd)/config/certbot-webroot:/var/www/certbot \
  nginx:alpine
```

### 7.3 è·å– SSL è¯ä¹¦

```bash
# è¿è¡Œ Certbot è·å–è¯ä¹¦
docker run --rm \
  -v $(pwd)/ssl:/etc/letsencrypt \
  -v $(pwd)/config/certbot-webroot:/var/www/certbot \
  certbot/certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email admin@yourcompany.com \
  --agree-tos \
  --no-eff-email \
  -d chat.yourcompany.com

# åœæ­¢ä¸´æ—¶ Nginx
docker stop temp-nginx
docker rm temp-nginx
```

**âš ï¸ é‡è¦ï¼š** è¯·å°†é‚®ç®±å’ŒåŸŸåæ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä¿¡æ¯ã€‚

### 7.4 éªŒè¯è¯ä¹¦

```bash
# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶
ls -la ssl/live/chat.yourcompany.com/

# åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š
# cert.pem -> ../../archive/chat.yourcompany.com/cert1.pem
# chain.pem -> ../../archive/chat.yourcompany.com/chain1.pem
# fullchain.pem -> ../../archive/chat.yourcompany.com/fullchain1.pem
# privkey.pem -> ../../archive/chat.yourcompany.com/privkey1.pem
```

## ğŸš€ ç¬¬å…«æ­¥ï¼šå¯åŠ¨æœåŠ¡

### 8.1 æ‹‰å–é•œåƒ

```bash
cd /opt/rocketchat

# æ‹‰å–æ‰€éœ€çš„ Docker é•œåƒ
docker-compose pull
```

### 8.2 å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### 8.3 éªŒè¯æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps

# æ£€æŸ¥ Rocket.Chat å¥åº·çŠ¶æ€
curl -f http://localhost:3000/api/info

# æ£€æŸ¥ MongoDB è¿æ¥
docker exec rocketchat-mongo mongo --eval "db.adminCommand('ismaster')"
```

## ğŸ”§ ç¬¬ä¹æ­¥ï¼šåˆå§‹åŒ–é…ç½®

### 9.1 è®¿é—®åº”ç”¨

1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š`https://chat.yourcompany.com`
2. å¦‚æœçœ‹åˆ° Rocket.Chat ç™»å½•é¡µé¢ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸ

### 9.2 åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·

1. é¦–æ¬¡è®¿é—®ä¼šçœ‹åˆ°è®¾ç½®å‘å¯¼
2. æŒ‰ç…§å‘å¯¼åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·
3. é…ç½®ç»„ç»‡ä¿¡æ¯
4. å®Œæˆåˆå§‹è®¾ç½®

### 9.3 éªŒè¯å“ç‰Œå®šåˆ¶

1. ç™»å½•åæ£€æŸ¥ä¾§è¾¹æ åº•éƒ¨æ˜¯å¦æ˜¾ç¤º "HT.Chat æ¬¢è¿æ‚¨ï¼"
2. ç¡®è®¤å“ç‰Œå®šåˆ¶å·²ç”Ÿæ•ˆ

## ğŸ“Š ç¬¬åæ­¥ï¼šç›‘æ§å’Œç»´æŠ¤

### 10.1 è®¾ç½®æ—¥å¿—è½®è½¬

```bash
# åˆ›å»º logrotate é…ç½®
sudo nano /etc/logrotate.d/rocketchat
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```
/opt/rocketchat/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        docker-compose -f /opt/rocketchat/docker-compose.yml restart rocketchat
    endscript
}
```

### 10.2 è®¾ç½®è‡ªåŠ¨å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
nano /opt/rocketchat/backup.sh
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash

# å¤‡ä»½é…ç½®
BACKUP_DIR="/opt/rocketchat/backups"
DATE=$(date +"%Y%m%d_%H%M%S")
BACKUP_NAME="rocketchat_backup_$DATE"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR/$BACKUP_NAME"

# å¤‡ä»½ MongoDB
docker exec rocketchat-mongo mongodump --out "/backups/$BACKUP_NAME/mongodb"

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
cp -r /opt/rocketchat/data/uploads "$BACKUP_DIR/$BACKUP_NAME/"

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp /opt/rocketchat/.env "$BACKUP_DIR/$BACKUP_NAME/"
cp /opt/rocketchat/docker-compose.yml "$BACKUP_DIR/$BACKUP_NAME/"
cp /opt/rocketchat/config/nginx.conf "$BACKUP_DIR/$BACKUP_NAME/"

# å‹ç¼©å¤‡ä»½
cd "$BACKUP_DIR"
tar -czf "$BACKUP_NAME.tar.gz" "$BACKUP_NAME"
rm -rf "$BACKUP_NAME"

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_NAME.tar.gz"
```

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /opt/rocketchat/backup.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½ï¼‰
0 2 * * * /opt/rocketchat/backup.sh >> /opt/rocketchat/logs/backup.log 2>&1
```

### 10.3 SSL è¯ä¹¦è‡ªåŠ¨ç»­æœŸ

```bash
# åˆ›å»ºè¯ä¹¦ç»­æœŸè„šæœ¬
nano /opt/rocketchat/renew-ssl.sh
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash

cd /opt/rocketchat

# ç»­æœŸè¯ä¹¦
docker run --rm \
  -v $(pwd)/ssl:/etc/letsencrypt \
  -v $(pwd)/config/certbot-webroot:/var/www/certbot \
  certbot/certbot renew

# é‡å¯ Nginx
docker-compose restart nginx

echo "SSL è¯ä¹¦ç»­æœŸæ£€æŸ¥å®Œæˆ"
```

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /opt/rocketchat/renew-ssl.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æœˆ 1 å·æ£€æŸ¥ç»­æœŸï¼‰
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œ
0 3 1 * * /opt/rocketchat/renew-ssl.sh >> /opt/rocketchat/logs/ssl-renew.log 2>&1
```

### 10.4 ç›‘æ§è„šæœ¬

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
nano /opt/rocketchat/monitor.sh
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service() {
    local service=$1
    local status=$(docker-compose ps -q $service | xargs docker inspect -f '{{.State.Status}}')
    
    if [ "$status" != "running" ]; then
        echo "[$(date)] è­¦å‘Š: $service æœåŠ¡æœªè¿è¡Œ" >> /opt/rocketchat/logs/monitor.log
        # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥
        docker-compose restart $service
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    local usage=$(df /opt/rocketchat | awk 'NR==2 {print $5}' | sed 's/%//')
    
    if [ $usage -gt 80 ]; then
        echo "[$(date)] è­¦å‘Š: ç£ç›˜ä½¿ç”¨ç‡è¾¾åˆ° $usage%" >> /opt/rocketchat/logs/monitor.log
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
check_memory() {
    local usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    
    if [ $usage -gt 90 ]; then
        echo "[$(date)] è­¦å‘Š: å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ° $usage%" >> /opt/rocketchat/logs/monitor.log
    fi
}

cd /opt/rocketchat

# æ‰§è¡Œæ£€æŸ¥
check_service "rocketchat"
check_service "mongo"
check_service "nginx"
check_disk_space
check_memory

echo "[$(date)] ç›‘æ§æ£€æŸ¥å®Œæˆ" >> /opt/rocketchat/logs/monitor.log
```

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /opt/rocketchat/monitor.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œ
*/5 * * * * /opt/rocketchat/monitor.sh
```

## ğŸ”§ ç¬¬åä¸€æ­¥ï¼šå¸¸ç”¨ç®¡ç†å‘½ä»¤

### 11.1 æœåŠ¡ç®¡ç†

```bash
cd /opt/rocketchat

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart rocketchat
docker-compose restart nginx
docker-compose restart mongo

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f rocketchat
docker-compose logs -f nginx
docker-compose logs -f mongo

# æ›´æ–°é•œåƒ
docker-compose pull
docker-compose up -d
```

### 11.2 æ•°æ®åº“ç®¡ç†

```bash
# è¿›å…¥ MongoDB å®¹å™¨
docker exec -it rocketchat-mongo mongo

# æŸ¥çœ‹æ•°æ®åº“
show dbs
use rocketchat
show collections

# å¤‡ä»½æ•°æ®åº“
docker exec rocketchat-mongo mongodump --out /backups/manual_backup

# æ¢å¤æ•°æ®åº“
docker exec rocketchat-mongo mongorestore /backups/manual_backup
```

### 11.3 æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /opt/rocketchat/logs/*.log

# æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# æŸ¥çœ‹ Docker å®¹å™¨æ—¥å¿—
docker logs -f rocketchat-app
docker logs -f rocketchat-mongo
docker logs -f rocketchat-nginx
```

## ğŸš¨ ç¬¬åäºŒæ­¥ï¼šæ•…éšœæ’é™¤

### 12.1 å¸¸è§é—®é¢˜

#### é—®é¢˜ 1ï¼šæ— æ³•è®¿é—®ç½‘ç«™

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :80
netstat -tlnp | grep :443

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
sudo firewall-cmd --list-all

# æ£€æŸ¥ DNS è§£æ
nslookup chat.yourcompany.com
```

#### é—®é¢˜ 2ï¼šSSL è¯ä¹¦é—®é¢˜

```bash
# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶
ls -la /opt/rocketchat/ssl/live/chat.yourcompany.com/

# æµ‹è¯•è¯ä¹¦
openssl x509 -in /opt/rocketchat/ssl/live/chat.yourcompany.com/cert.pem -text -noout

# é‡æ–°è·å–è¯ä¹¦
/opt/rocketchat/renew-ssl.sh
```

#### é—®é¢˜ 3ï¼šæ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥ MongoDB çŠ¶æ€
docker exec rocketchat-mongo mongo --eval "db.adminCommand('ismaster')"

# æ£€æŸ¥å‰¯æœ¬é›†çŠ¶æ€
docker exec rocketchat-mongo mongo --eval "rs.status()"

# é‡æ–°åˆå§‹åŒ–å‰¯æœ¬é›†
docker-compose restart mongo-init-replica
```

### 12.2 æ€§èƒ½ä¼˜åŒ–

#### ä¼˜åŒ– MongoDB

```bash
# è¿›å…¥ MongoDB å®¹å™¨
docker exec -it rocketchat-mongo mongo

# åˆ›å»ºç´¢å¼•
use rocketchat
db.rocketchat_message.createIndex({"rid": 1, "ts": 1})
db.users.createIndex({"username": 1})
db.users.createIndex({"emails.address": 1})
```

#### ä¼˜åŒ– Nginx

ç¼–è¾‘ `/opt/rocketchat/config/nginx.conf`ï¼Œæ·»åŠ ç¼“å­˜é…ç½®ï¼š

```nginx
# åœ¨ http å—ä¸­æ·»åŠ 
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=rocketchat_cache:10m max_size=1g inactive=60m use_temp_path=off;

# åœ¨ location / å—ä¸­æ·»åŠ 
proxy_cache rocketchat_cache;
proxy_cache_valid 200 302 10m;
proxy_cache_valid 404 1m;
```

## ğŸ“‹ ç¬¬åä¸‰æ­¥ï¼šå®‰å…¨åŠ å›º

### 13.1 é˜²ç«å¢™é…ç½®

```bash
# Ubuntu/Debian (UFW)
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw deny 3000/tcp  # ç¦æ­¢ç›´æ¥è®¿é—® Rocket.Chat ç«¯å£

# CentOS/RHEL (firewalld)
sudo systemctl enable firewalld
sudo systemctl start firewalld
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 13.2 ç³»ç»Ÿå®‰å…¨æ›´æ–°

```bash
# åˆ›å»ºè‡ªåŠ¨æ›´æ–°è„šæœ¬
nano /opt/rocketchat/security-update.sh
```

æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```bash
#!/bin/bash

# æ›´æ–°ç³»ç»ŸåŒ…
apt update && apt upgrade -y

# æ›´æ–° Docker é•œåƒ
cd /opt/rocketchat
docker-compose pull
docker-compose up -d

# æ¸…ç†æ—§é•œåƒ
docker image prune -f

echo "[$(date)] å®‰å…¨æ›´æ–°å®Œæˆ" >> /opt/rocketchat/logs/security-update.log
```

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x /opt/rocketchat/security-update.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨ 4 ç‚¹ï¼‰
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œ
0 4 * * 0 /opt/rocketchat/security-update.sh
```

## ğŸ‰ éƒ¨ç½²å®Œæˆ

æ­å–œï¼æ‚¨å·²ç»æˆåŠŸå®Œæˆäº† Rocket.Chat çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€‚ç°åœ¨æ‚¨å¯ä»¥ï¼š

1. **è®¿é—®åº”ç”¨**ï¼šhttps://chat.yourcompany.com
2. **ç®¡ç†åå°**ï¼šhttps://chat.yourcompany.com/admin
3. **ç›‘æ§æ—¥å¿—**ï¼š`/opt/rocketchat/logs/`
4. **æŸ¥çœ‹å¤‡ä»½**ï¼š`/opt/rocketchat/backups/`

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. **æ—¥å¿—æ–‡ä»¶**ï¼š`/opt/rocketchat/logs/`
2. **Docker æ—¥å¿—**ï¼š`docker-compose logs`
3. **ç³»ç»Ÿæ—¥å¿—**ï¼š`journalctl -u docker`
4. **ç½‘ç»œè¿æ¥**ï¼šç¡®ä¿åŸŸåè§£ææ­£ç¡®
5. **é˜²ç«å¢™è®¾ç½®**ï¼šç¡®ä¿ç«¯å£ 80 å’Œ 443 å¼€æ”¾

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Rocket.Chat å®˜æ–¹æ–‡æ¡£](https://docs.rocket.chat/)
- [Docker Compose æ–‡æ¡£](https://docs.docker.com/compose/)
- [Nginx é…ç½®æŒ‡å—](https://nginx.org/en/docs/)
- [Let's Encrypt æ–‡æ¡£](https://letsencrypt.org/docs/)
- [MongoDB æ–‡æ¡£](https://docs.mongodb.com/)

---

**ğŸ”’ å®‰å…¨æé†’**ï¼š
- å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œåº”ç”¨
- ä½¿ç”¨å¼ºå¯†ç 
- å®šæœŸå¤‡ä»½æ•°æ®
- ç›‘æ§ç³»ç»Ÿæ—¥å¿—
- åŠæ—¶åº”ç”¨å®‰å…¨è¡¥ä¸

**ğŸ“ˆ æ€§èƒ½å»ºè®®**ï¼š
- æ ¹æ®ç”¨æˆ·æ•°é‡è°ƒæ•´æœåŠ¡å™¨é…ç½®
- å®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- è€ƒè™‘ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº

ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸš€