# Rocket.Chat 服务器部署指南

## 服务器信息
- **服务器IP**: 206.238.115.75
- **用户名**: root
- **密码**: B678*fdWeasQ
- **域名**: im.lc2023.com

## 快速部署步骤

### 1. 连接服务器
```bash
ssh root@206.238.115.75
# 输入密码: B678*fdWeasQ
```

### 2. 上传部署文件
在本地执行以下命令，将配置文件上传到服务器：

```bash
# 创建临时目录
mkdir -p /tmp/rocketchat-deploy
cd /tmp/rocketchat-deploy

# 复制所有配置文件
cp /home/admin888/code/Rocket.Chat/docker-compose.prod.yml .
cp /home/admin888/code/Rocket.Chat/mongo-init.js .
cp -r /home/admin888/code/Rocket.Chat/nginx .
cp /home/admin888/code/Rocket.Chat/setup-ssl.sh .
cp /home/admin888/code/Rocket.Chat/deploy.sh .

# 上传到服务器
scp -r . root@206.238.115.75:/root/rocketchat-deploy/
```

### 3. 在服务器上执行部署
```bash
# 连接到服务器
ssh root@206.238.115.75

# 进入部署目录
cd /root/rocketchat-deploy

# 给脚本执行权限
chmod +x deploy.sh setup-ssl.sh

# 执行一键部署脚本
./deploy.sh
```

## 手动部署步骤（如果自动脚本失败）

### 1. 系统准备
```bash
# 更新系统
apt update && apt upgrade -y

# 安装基础工具
apt install -y curl wget git unzip software-properties-common apt-transport-https ca-certificates gnupg lsb-release
```

### 2. 安装 Docker
```bash
# 添加 Docker 官方 GPG 密钥
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# 添加 Docker 仓库
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# 安装 Docker
apt update
apt install -y docker-ce docker-ce-cli containerd.io

# 启动 Docker 服务
systemctl start docker
systemctl enable docker
```

### 3. 安装 Docker Compose
```bash
# 下载 Docker Compose
curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# 给执行权限
chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 4. 配置防火墙
```bash
# 启用 UFW
ufw --force enable

# 允许必要端口
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp

# 查看状态
ufw status
```

### 5. 创建部署目录
```bash
# 创建目录
mkdir -p /opt/rocketchat
cd /opt/rocketchat

# 复制配置文件（从上传的文件）
cp /root/rocketchat-deploy/* .
cp -r /root/rocketchat-deploy/nginx .
```

### 6. 检查域名 DNS
```bash
# 检查域名解析
dig +short im.lc2023.com
# 应该返回: 206.238.115.75
```

### 7. 启动服务
```bash
# 启动基础服务
docker-compose -f docker-compose.prod.yml up -d mongo mongo-init-replica

# 等待 MongoDB 启动
sleep 30

# 启动 Rocket.Chat
docker-compose -f docker-compose.prod.yml up -d rocketchat

# 等待 Rocket.Chat 启动
sleep 60
```

### 8. 配置 SSL 证书
```bash
# 运行 SSL 配置脚本
./setup-ssl.sh
```

### 9. 启动完整服务
```bash
# 启动所有服务
docker-compose -f docker-compose.prod.yml up -d

# 查看服务状态
docker-compose -f docker-compose.prod.yml ps
```

## 验证部署

### 1. 检查服务状态
```bash
# 查看所有容器状态
docker-compose -f docker-compose.prod.yml ps

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f rocketchat
```

### 2. 测试网站访问
```bash
# 测试 HTTP 重定向
curl -I http://im.lc2023.com

# 测试 HTTPS 访问
curl -I https://im.lc2023.com

# 测试 API
curl https://im.lc2023.com/api/info
```

### 3. 访问管理界面
- 打开浏览器访问: https://im.lc2023.com
- 使用管理员账号登录:
  - 用户名: `admin`
  - 密码: `ChangeThisPassword123!`
  - 邮箱: `admin@lc2023.com`

## 安全配置（部署后必做）

### 1. 修改默认密码
```bash
# 编辑 docker-compose.prod.yml
vim docker-compose.prod.yml

# 修改以下环境变量:
# - ADMIN_PASS=你的新密码
# - MONGO_INITDB_ROOT_PASSWORD=新的MongoDB密码

# 重启服务
docker-compose -f docker-compose.prod.yml restart
```

### 2. 配置邮件服务
在 Rocket.Chat 管理界面中配置 SMTP 设置:
- 进入 管理 > 邮件 > SMTP
- 配置你的邮件服务器信息

### 3. 设置备份
```bash
# 创建备份脚本
cat > backup.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups/rocketchat"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份 MongoDB
docker-compose -f docker-compose.prod.yml exec -T mongo mongodump --archive | gzip > $BACKUP_DIR/mongo_$DATE.gz

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz -C /opt/rocketchat rocketchat_uploads/

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +7 -delete
EOF

chmod +x backup.sh

# 添加到定时任务（每天凌晨2点备份）
(crontab -l 2>/dev/null; echo "0 2 * * * /opt/rocketchat/backup.sh") | crontab -
```

## 常用维护命令

```bash
# 查看服务状态
docker-compose -f docker-compose.prod.yml ps

# 查看实时日志
docker-compose -f docker-compose.prod.yml logs -f

# 重启服务
docker-compose -f docker-compose.prod.yml restart

# 停止服务
docker-compose -f docker-compose.prod.yml down

# 更新镜像
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d

# SSL 证书续期
./renew-ssl.sh

# 查看磁盘使用
df -h
du -sh /opt/rocketchat/

# 清理 Docker
docker system prune -f
```

## 故障排除

### 1. 服务无法启动
```bash
# 查看详细日志
docker-compose -f docker-compose.prod.yml logs rocketchat
docker-compose -f docker-compose.prod.yml logs mongo
docker-compose -f docker-compose.prod.yml logs nginx

# 检查端口占用
netstat -tlnp | grep :3000
netstat -tlnp | grep :80
netstat -tlnp | grep :443
```

### 2. SSL 证书问题
```bash
# 检查证书文件
ls -la ssl/live/im.lc2023.com/

# 手动申请证书
docker-compose -f docker-compose.prod.yml run --rm certbot certonly --webroot --webroot-path=/var/www/certbot --email admin@lc2023.com --agree-tos --no-eff-email -d im.lc2023.com

# 测试 Nginx 配置
docker-compose -f docker-compose.prod.yml exec nginx nginx -t
```

### 3. 数据库连接问题
```bash
# 检查 MongoDB 状态
docker-compose -f docker-compose.prod.yml exec mongo mongosh --eval "db.adminCommand('ping')"

# 检查副本集状态
docker-compose -f docker-compose.prod.yml exec mongo mongosh --eval "rs.status()"
```

## 监控和告警

### 1. 基础监控脚本
```bash
cat > monitor.sh << 'EOF'
#!/bin/bash

# 检查服务状态
if ! docker-compose -f docker-compose.prod.yml ps | grep -q "Up"; then
    echo "警告: Rocket.Chat 服务异常" | mail -s "Rocket.Chat 告警" admin@lc2023.com
fi

# 检查磁盘空间
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "警告: 磁盘使用率超过80%" | mail -s "磁盘空间告警" admin@lc2023.com
fi

# 检查内存使用
MEM_USAGE=$(free | awk 'NR==2{printf "%.0f", $3*100/$2 }')
if [ $MEM_USAGE -gt 90 ]; then
    echo "警告: 内存使用率超过90%" | mail -s "内存告警" admin@lc2023.com
fi
EOF

chmod +x monitor.sh

# 每5分钟检查一次
(crontab -l 2>/dev/null; echo "*/5 * * * * /opt/rocketchat/monitor.sh") | crontab -
```

## 性能优化建议

1. **MongoDB 优化**:
   - 增加 oplog 大小
   - 配置适当的索引
   - 定期清理日志

2. **Nginx 优化**:
   - 启用 HTTP/2
   - 配置适当的缓存
   - 优化 worker 进程数

3. **系统优化**:
   - 调整文件描述符限制
   - 优化内核参数
   - 配置 swap

---

**重要提醒**: 部署完成后，请立即修改所有默认密码，配置邮件服务，并设置定期备份！